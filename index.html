<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TOKEN ç®¡ç†åå°</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #0a0f1c;
    color: #eaf0ff;
    padding: 20px;
  }
  .card {
    background: #111827;
    padding: 20px;
    border-radius: 12px;
    max-width: 420px;
    margin: auto;
  }
  input, select, button {
    width: 100%;
    padding: 10px;
    margin-top: 12px;
    border-radius: 8px;
    border: none;
  }
  button {
    background: #2563eb;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background: #1e40af;
  }
</style>
</head>
<body>

<div class="card">
  <h2>ğŸ” Token ç®¡ç†åå°</h2>

  <label>UIDï¼ˆå¿…å¡«ï¼‰</label>
  <input id="uidInput" placeholder="è¯·è¾“å…¥ UID">

  <label>é€‰æ‹© APPï¼ˆfileï¼‰</label>
  <select id="appSelect">
    <option value="">åŠ è½½ä¸­â€¦</option>
  </select>

  <button onclick="generateToken()">ç”Ÿæˆå¹¶å†™å…¥ TOKENS KV</button>

  <p id="result"></p>
</div>

<script>
// ==========================
// ä½ çš„ Worker é…ç½®ï¼ˆå·²æ›¿æ¢ï¼‰
// ==========================
const CF_API_TOKEN = "y3qPKC2DbN_By1F8AzVSZGcXUM-fP2g77RGCDzLI";
const ACCOUNT_ID = "a1cae400db00deda5b1111b4c615aa03";
const KV_NAMESPACE_ID = "08f9db9c4de74ffabb56c39ae6cb470d";

// ==========================
// åŠ è½½ R2 é‡Œçš„ downloads.json
// ==========================
async function loadApps() {
  try {
    const res = await fetch("https://app.powertech.workers.dev/r2/downloads.json");
    const data = await res.json();

    const select = document.getElementById("appSelect");
    select.innerHTML = "";

    if (!data.downloads || data.downloads.length === 0) {
      select.innerHTML = "<option value=''>æ— å¯ç”¨ APP</option>";
      return;
    }

    // ä¿®å¤ç‚¹ï¼šä½¿ç”¨ url å­—æ®µï¼Œè€Œä¸æ˜¯ file
    data.downloads.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item.url;      // ğŸ‘ˆ ä½¿ç”¨ä½ çš„å­—æ®µ
      opt.textContent = item.name + " (" + item.url + ")";
      select.appendChild(opt);
    });
  } catch (err) {
    document.getElementById("appSelect").innerHTML =
      "<option value=''>åŠ è½½å¤±è´¥</option>";
  }
}
loadApps();

// ==========================
// ç”Ÿæˆ 5 ä½éšæœºæ•°å­—
// ==========================
function randomCode() {
  return Math.floor(10000 + Math.random() * 90000).toString();
}

// ==========================
// å†™å…¥ KV
// ==========================
async function generateToken() {
  const uid = document.getElementById("uidInput").value.trim();
  const file = document.getElementById("appSelect").value;

  if (!uid) {
    alert("è¯·è¾“å…¥ UID");
    return;
  }
  if (!file) {
    alert("è¯·é€‰æ‹©ä¸€ä¸ª APP");
    return;
  }

  const shortCode = randomCode();

  const value = JSON.stringify({ uid, file });

  const url = `https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/storage/kv/namespaces/${KV_NAMESPACE_ID}/values/${shortCode}`;

  try {
    const res = await fetch(url, {
      method: "PUT",
      headers: {
        "Authorization": `Bearer ${CF_API_TOKEN}`,
        "Content-Type": "text/plain"
      },
      body: value
    });

    if (!res.ok) throw new Error("KV å†™å…¥å¤±è´¥");

    document.getElementById("result").innerHTML =
      `ğŸ‰ æˆåŠŸï¼<br>çŸ­ç ï¼š<b>${shortCode}</b><br>ä¸‹è½½é“¾æ¥ï¼š<br>
      <a href="https://app.powertech.workers.dev/${shortCode}" target="_blank">
      https://app.powertech.workers.dev/${shortCode}</a>`;
  } catch (err) {
    document.getElementById("result").innerText = "ç½‘ç»œæˆ–ç¨‹åºé”™è¯¯: " + err.message;
  }
}
</script>

</body>
</html>
