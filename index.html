/* ============================================================
   CONSTANTS â€” BASELINE SAFE
============================================================ */
const SIGN_SECRET = "mySuperSecretKey";
const TOKEN_PREFIX = "TOKEN:";
const DEV_PREFIX = "DEV:";
const TOKEN_TTL_SECONDS = 365 * 24 * 60 * 60; // 1 year
const MAX_DEVICES = 3;

const R2_PREFIX = "private-files/";
const DEVICE_CONFLICT_URL = "https://modskyshop168-sudo.github.io/cc/device.html";

/* ============================================================
   Frontend HTML
============================================================ */
const FRONTEND_HTML = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”— æ™ºèƒ½ä¸‹è½½é“¾æ¥ç”Ÿæˆå™¨</title>
<style>
  body{font-family:system-ui,sans-serif;margin:0;padding:20px;text-align:center;background:#0a0f1c;color:#eaf0ff;}
  h1{font-size:26px;margin-bottom:10px;}
  .version-btn{display:block;width:90%;margin:6px auto;padding:12px;background:#1f2f4a;border:none;color:#fff;border-radius:8px;cursor:pointer;font-size:16px;}
  .selected{background:#3575ff;}
  #generateTokenBtn{margin-top:20px;padding:14px 20px;font-size:18px;border:none;border-radius:10px;background:#3575ff;color:#fff;cursor:pointer;}
</style>
</head>
<body>

<h1>ğŸ”— æ™ºèƒ½ä¸‹è½½é“¾æ¥ç”Ÿæˆå™¨</h1>
<h2 id="title">âš¡ è¯·é€‰æ‹©è¦ä¸‹è½½çš„åº”ç”¨ç‰ˆæœ¬</h2>

<div id="versionContainer"></div>

<button id="generateTokenBtn">Click to Generate Token</button>

<div id="output"></div>

<script>
const r2DownloadsEndpoint = "/r2/downloads.json";
let selectedVersion = null;

async function loadVersions() {
  const container = document.getElementById("versionContainer");
  try {
    const res = await fetch(r2DownloadsEndpoint);
    const data = await res.json();

    (data.downloads || []).forEach(app => {
      const btn = document.createElement("button");
      btn.className = "version-btn";
      btn.dataset.version = app.zone;
      btn.textContent = app.name;

      btn.addEventListener("click", () => {
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Token ç”Ÿæˆå™¨</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:#0b1220;color:#e6eef8;padding:28px}
  .card{max-width:760px;margin:20px auto;padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));box-shadow:0 6px 18px rgba(2,6,23,0.6)}
  label{display:block;margin:12px 0 6px;font-weight:600}
  input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>Token Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: system-ui; padding: 20px; background: #0b1224; color: #e8eeff; }
  h2 { margin-bottom: 0.5em; }
  input, button {
    font-size: 18px; padding: 10px; width: 100%; margin-top: 10px;
    border-radius: 10px; border: none;
  }
  button {
    background: #4e8cff; color: white; cursor: pointer; margin-top: 15px;
  }
  .box {
    margin-top: 20px; padding: 15px; background: #131b33; border-radius: 12px;
    word-break: break-all; font-size: 18px;
  }
</style>
</head>
<body>

<h2>ğŸ” UID â†’ Token ç”Ÿæˆå™¨ï¼ˆ5 ä½æ•°å­—ï¼‰</h2>

<label>è¯·è¾“å…¥ UIDï¼š</label>
<input id="uid" placeholder="ä¾‹å¦‚ï¼šuser123" />

<button onclick="makeToken()">ç”Ÿæˆ TOKEN</button>

<div id="output" class="box" style="display:none;"></div>

<script>
async function makeToken() {
  const uid = document.getElementById("uid").value.trim();
  if (!uid) {
    alert("è¯·è¾“å…¥ UID");
    return;
  }

  // === éšæœº 5 ä½æ•°å­— token ===
  const token = String(Math.floor(10000 + Math.random() * 90000));

  // === Cloudflare KV å†™å…¥ï¼ˆTOKENSï¼‰ ===
  const CF_API_TOKEN = "y3qPKC2DbN_By1F8AzVSZGcXUM-fP2g77RGCDzLI";  // â† æ›¿æ¢
  const ACCOUNT_ID = "YOUR_ACCOUNT_ID";   // â† æ›¿æ¢
  const NAMESPACE_ID = "08f9db9c4de74ffabb56c39ae6cb470d"; // â† æ›¿æ¢ï¼ˆKV: TOKENSï¼‰

  const url = `https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/storage/kv/namespaces/${NAMESPACE_ID}/values/${token}`;

  const res = await fetch(url, {
    method: "PUT",
    headers: {
      "Authorization": `Bearer ${CF_API_TOKEN}`,
      "Content-Type": "text/plain"
    },
    body: uid
  });

  if (!res.ok) {
    alert("âŒ å†™å…¥ KV å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Token æƒé™");
    return;
  }

  const finalURL = `https://app.powertech.workers.dev/${token}`;

  document.getElementById("output").style.display = "block";
  document.getElementById("output").innerHTML = `
    âœ… <b>UIDï¼š</b> ${uid}<br>
    âœ… <b>Tokenï¼š</b> ${token}<br><br>
    ğŸ”— ä¸‹è½½é“¾æ¥ï¼š<br>
    <a href="${finalURL}" target="_blank" style="color:#7db3ff;">${finalURL}</a>
  `;
}
</script>

</body>
</html>
