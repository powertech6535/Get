<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=430, user-scalable=no">
<title>Token 管理后台</title>

<style>
  body {
    margin: 0;
    padding: 20px;
    font-family: system-ui, sans-serif;
    background: radial-gradient(circle at 20% 20%, #0a0f2e, #020311 60%, #000 100%);
    color: #fff;
    min-height: 100vh;
  }

  h2 { text-align: center; font-size: 26px; margin-bottom: 25px; }

  input {
    width: 100%;
    padding: 14px;
    font-size: 18px;
    border-radius: 10px;
    border: none;
    margin-bottom: 20px;
  }

  button.main {
    width: 100%;
    padding: 14px;
    font-size: 20px;
    background: linear-gradient(90deg, #00d2ff, #007AFF);
    border: none;
    border-radius: 12px;
    color: #fff;
    margin-top: 10px;
  }

  #apps {
    margin-top: 20px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .app-btn {
    padding: 12px;
    background: #1a1f3c;
    border-radius: 10px;
    border: 2px solid #2a2f55;
    text-align: center;
    font-size: 15px;
  }

  .app-btn.selected {
    background: #007AFF;
    border-color: #00d2ff;
  }

  #result {
    margin-top: 25px;
    text-align: center;
    font-size: 18px;
  }

  .copy-btn {
    margin-top: 15px;
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    background: #00b894;
    color: #fff;
    font-size: 18px;
    border: none;
  }
</style>
</head>

<body>
<h2>Token 管理后台</h2>

<label>UID（必填）</label>
<input id="uid" placeholder="请输入 UID">

<button class="main" onclick="generateToken()">生成并写入 Token</button>

<!-- APP 按钮区（自动生成） -->
<div id="apps"></div>

<div id="result"></div>

<script>
const API = "https://app.powertech.workers.dev";
let selectedFile = null;     // ← 永远记录当前选择的 APK
let lastCode = null;         // ← 永远记录本次生成的 5 位短码（不会 undefined）

// === 加载 R2 列表并生成按钮 ===
async function loadApps() {
  const box = document.getElementById("apps");
  box.innerHTML = "<div style='grid-column:1/3;text-align:center'>加载中…</div>";

  try {
    const res = await fetch(API + "/r2/downloads.json");
    const data = await res.json();

    box.innerHTML = "";

    data.downloads.forEach(item => {
      const btn = document.createElement("div");
      btn.className = "app-btn";
      btn.textContent = item.name;
      btn.onclick = () => selectApp(item.url, btn);
      box.appendChild(btn);
    });

  } catch (e) {
    box.innerHTML = "<div style='grid-column:1/3;text-align:center;color:red'>加载失败</div>";
  }
}

function selectApp(url, btn) {
  selectedFile = url;   // 记录 file 正确值（不会 undefined）

  document.querySelectorAll(".app-btn").forEach(b => b.classList.remove("selected"));
  btn.classList.add("selected");
}

// === 生成随机 5 位短码 ===
function randomCode() {
  return Math.floor(10000 + Math.random() * 90000).toString();
}

// === 提交到 Worker（不会产生 undefined） ===
async function generateToken() {
  const uid = document.getElementById("uid").value.trim();
  const result = document.getElementById("result");

  if (!uid) {
    result.style.color = "red";
    result.textContent = "请输入 UID";
    return;
  }

  if (!selectedFile) {
    result.style.color = "red";
    result.textContent = "请选择 APP";
    return;
  }

  lastCode = randomCode();   // 保存短码 ↓↓↓
  const body = { code: lastCode, uid, file: selectedFile };

  try {
    const res = await fetch(API + "/api/create-token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const t = await res.text();
      throw new Error("HTTP " + res.status + "：" + t);
    }

    result.style.color = "lightgreen";
    result.innerHTML =
      `写入成功！<br><br>
       <b>下载链接：</b><br>
       <a href="${API}/${lastCode}" target="_blank">${API}/${lastCode}</a><br>
       <button class="copy-btn" onclick="copyLink()">复制下载链接</button>`;
  } catch (e) {
    result.style.color = "red";
    result.textContent = "写入失败：" + e;
  }
}

function copyLink() {
  navigator.clipboard.writeText(`${API}/${lastCode}`);
}
loadApps();
</script>

</body>
</html>
