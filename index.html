<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">

<!-- 强制电脑与手机一样的手机版布局 -->
<meta name="viewport" content="width=430, user-scalable=no">

<title>Token 管理后台</title>

<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background: radial-gradient(circle at top, #0a0f1c, #02040a); /* ✔ 保留你的炫背景 */
    color: #eaf0ff;
    display: flex;
    justify-content: center;
  }

  .container {
    width: 100%;
    max-width: 430px;
    padding: 20px;
    box-sizing: border-box;
  }

  h2 {
    text-align: center;
    margin-bottom: 20px;
  }

  input {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    border-radius: 10px;
    border: none;
    margin-top: 10px;
    box-sizing: border-box;
  }

  button.main-btn {
    width: 100%;
    padding: 16px;
    margin-top: 15px;
    font-size: 20px;
    background: #007AFF;
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
  }

  /* APP 按钮网格 2 列 */
  .app-grid {
    margin-top: 20px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .app-btn {
    padding: 14px;
    font-size: 16px;
    border-radius: 10px;
    background: rgba(255,255,255,0.15);
    border: 1px solid #4d6aff;
    text-align: center;
    cursor: pointer;
  }

  .app-btn.selected {
    background: #4d6aff;
  }

  /* 成功显示区域 */
  .result-box {
    margin-top: 25px;
    padding: 15px;
    border-radius: 10px;
    background: rgba(0,0,0,0.4);
    display: none;
  }

  .copy-btn {
    margin-top: 10px;
    width: 100%;
    padding: 15px;
    font-size: 18px;
    border-radius: 10px;
    border: none;
    background: #34C759;
    color: white;
    cursor: pointer;
  }

  #msg {
    margin-top: 15px;
    font-size: 16px;
  }

</style>
</head>

<body>
<div class="container">

  <h2>Token 管理（5 位短码）</h2>

  <label>UID（必填）</label>
  <input id="uid" placeholder="请输入 UID">

  <button class="main-btn" onclick="generateToken()">生成并写入 Token</button>

  <!-- APP 按钮容器 -->
  <div id="appList" class="app-grid"></div>

  <div id="msg"></div>

  <!-- 结果显示区 -->
  <div id="result" class="result-box">
    <div id="downloadLink" style="word-break: break-all;"></div>
    <button class="copy-btn" onclick="copyLink()">复制下载链接</button>
  </div>

</div>

<script>
const API = "https://app.powertech.workers.dev";

let selectedFile = "";
let lastGeneratedCode = "";

/* 自动加载 R2 app 列表并按钮化 */
async function loadFiles() {
  const box = document.getElementById("appList");
  box.innerHTML = "<div style='grid-column: span 2; text-align:center;'>加载中…</div>";

  try {
    const res = await fetch(API + "/r2/downloads.json");
    const data = await res.json();

    if (!data.downloads || data.downloads.length === 0) {
      box.innerHTML = "<div style='grid-column: span 2; text-align:center;'>无可用 APP</div>";
      return;
    }

    box.innerHTML = "";

    data.downloads.forEach(item => {
      const btn = document.createElement("div");
      btn.className = "app-btn";
      btn.textContent = item.name;

      btn.onclick = () => {
        selectedFile = item.url;

        // highlight
        document.querySelectorAll(".app-btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
      };

      box.appendChild(btn);
    });

  } catch (err) {
    box.innerHTML = "<div style='grid-column: span 2; text-align:center;'>加载失败</div>";
    console.error(err);
  }
}


/* 生成 Token */
async function generateToken() {
  const uid = document.getElementById("uid").value.trim();
  const msg = document.getElementById("msg");
  msg.textContent = "";
  msg.style.color = "red";

  if (!uid) {
    msg.textContent = "请输入 UID";
    return;
  }

  if (!selectedFile) {
    msg.textContent = "请选择一个 APP";
    return;
  }

  try {
    const res = await fetch(API + "/api/create-token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ uid, file: selectedFile })
    });

    const data = await res.json();

    if (!res.ok || !data.short) {
      msg.textContent = "写入失败：" + (data.error || "未知错误");
      return;
    }

    lastGeneratedCode = data.short;

    msg.style.color = "lime";
    msg.textContent = "写入成功！";

    // 显示结果区域
    document.getElementById("result").style.display = "block";
    document.getElementById("downloadLink").innerHTML =
      `${API}/${data.short}`;

  } catch (e) {
    msg.textContent = "写入失败：" + e;
  }
}

/* 复制按钮 */
function copyLink() {
  const url = `${API}/${lastGeneratedCode}`;
  navigator.clipboard.writeText(url).then(() => {
    alert("复制成功！");
  });
}

loadFiles();
</script>

</body>
</html>
