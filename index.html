/* ============================================================
   CONSTANTS â€” BASELINE SAFE
============================================================ */
const SIGN_SECRET = "mySuperSecretKey";
const TOKEN_PREFIX = "TOKEN:";
const DEV_PREFIX = "DEV:";
const TOKEN_TTL_SECONDS = 365 * 24 * 60 * 60; // 1 year
const MAX_DEVICES = 3;

const R2_PREFIX = "private-files/";
const DEVICE_CONFLICT_URL = "https://modskyshop168-sudo.github.io/cc/device.html";

/* ============================================================
   Frontend HTML
============================================================ */
const FRONTEND_HTML = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”— æ™ºèƒ½ä¸‹è½½é“¾æ¥ç”Ÿæˆå™¨</title>
<style>
  body{font-family:system-ui,sans-serif;margin:0;padding:20px;text-align:center;background:#0a0f1c;color:#eaf0ff;}
  h1{font-size:26px;margin-bottom:10px;}
  .version-btn{display:block;width:90%;margin:6px auto;padding:12px;background:#1f2f4a;border:none;color:#fff;border-radius:8px;cursor:pointer;font-size:16px;}
  .selected{background:#3575ff;}
  #generateTokenBtn{margin-top:20px;padding:14px 20px;font-size:18px;border:none;border-radius:10px;background:#3575ff;color:#fff;cursor:pointer;}
</style>
</head>
<body>

<h1>ğŸ”— æ™ºèƒ½ä¸‹è½½é“¾æ¥ç”Ÿæˆå™¨</h1>
<h2 id="title">âš¡ è¯·é€‰æ‹©è¦ä¸‹è½½çš„åº”ç”¨ç‰ˆæœ¬</h2>

<div id="versionContainer"></div>

<button id="generateTokenBtn">Click to Generate Token</button>

<div id="output"></div>

<script>
const r2DownloadsEndpoint = "/r2/downloads.json";
let selectedVersion = null;

async function loadVersions() {
  const container = document.getElementById("versionContainer");
  try {
    const res = await fetch(r2DownloadsEndpoint);
    const data = await res.json();

    (data.downloads || []).forEach(app => {
      const btn = document.createElement("button");
      btn.className = "version-btn";
      btn.dataset.version = app.zone;
      btn.textContent = app.name;

      btn.addEventListener("click", () => {
        document.querySelectorAll(".version-btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        selectedVersion = app.zone;
        document.getElementById("output").textContent = "å·²é€‰æ‹©ï¼š" + app.name;
      });

      container.appendChild(btn);
    });

  } catch (err) {
    document.getElementById("output").textContent = "åŠ è½½ç‰ˆæœ¬å¤±è´¥ï¼š" + err.message;
  }
}

loadVersions();

document.getElementById("generateTokenBtn").addEventListener("click", async () => {
  if (!selectedVersion) {
    document.getElementById("output").textContent = "âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç‰ˆæœ¬";
    return;
  }

  const res = await fetch("/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ zone: selectedVersion })
  });

  const data = await res.json();

  if (data.error) {
    document.getElementById("output").textContent = "âŒ é”™è¯¯ï¼š" + data.error;
    return;
  }

  const link = location.origin + "/t/" + data.token;
  document.getElementById("output").textContent = "âœ… ä¸‹è½½é“¾æ¥å·²ç”Ÿæˆï¼š\\n" + link;
});
</script>

</body>
</html>
