/* ============================================================
   CONSTANTS â€” BASELINE SAFE
============================================================ */
const SIGN_SECRET = "mySuperSecretKey";
const TOKEN_PREFIX = "TOKEN:";
const DEV_PREFIX = "DEV:";
const TOKEN_TTL_SECONDS = 365 * 24 * 60 * 60; // 1 year
const MAX_DEVICES = 3;

const R2_PREFIX = "private-files/";
const DEVICE_CONFLICT_URL = "https://modskyshop168-sudo.github.io/cc/device.html";

/* ============================================================
   Frontend HTML
============================================================ */
const FRONTEND_HTML = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”— æ™ºèƒ½ä¸‹è½½é“¾æ¥ç”Ÿæˆå™¨</title>
<style>
  body{font-family:system-ui,sans-serif;margin:0;padding:20px;text-align:center;background:#0a0f1c;color:#eaf0ff;}
  h1{font-size:26px;margin-bottom:10px;}
  .version-btn{display:block;width:90%;margin:6px auto;padding:12px;background:#1f2f4a;border:none;color:#fff;border-radius:8px;cursor:pointer;font-size:16px;}
  .selected{background:#3575ff;}
  #generateTokenBtn{margin-top:20px;padding:14px 20px;font-size:18px;border:none;border-radius:10px;background:#3575ff;color:#fff;cursor:pointer;}
</style>
</head>
<body>

<h1>ğŸ”— æ™ºèƒ½ä¸‹è½½é“¾æ¥ç”Ÿæˆå™¨</h1>
<h2 id="title">âš¡ è¯·é€‰æ‹©è¦ä¸‹è½½çš„åº”ç”¨ç‰ˆæœ¬</h2>

<div id="versionContainer"></div>

<button id="generateTokenBtn">Click to Generate Token</button>

<div id="output"></div>

<script>
const r2DownloadsEndpoint = "/r2/downloads.json";
let selectedVersion = null;

async function loadVersions() {
  const container = document.getElementById("versionContainer");
  try {
    const res = await fetch(r2DownloadsEndpoint);
    const data = await res.json();

    (data.downloads || []).forEach(app => {
      const btn = document.createElement("button");
      btn.className = "version-btn";
      btn.dataset.version = app.zone;
      btn.textContent = app.name;

      btn.addEventListener("click", () => {
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Token ç”Ÿæˆå™¨</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:#0b1220;color:#e6eef8;padding:28px}
  .card{max-width:760px;margin:20px auto;padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));box-shadow:0 6px 18px rgba(2,6,23,0.6)}
  label{display:block;margin:12px 0 6px;font-weight:600}
  input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  button{cursor:pointer;margin-top:12px;padding:12px;font-weight:700}
  .row{display:flex;gap:10px}
  .small{width:160px}
  pre{white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;margin-top:10px}
  .hint{font-size:13px;color:#9fb0d6;margin-top:8px}
</style>
</head>
<body>
  <div class="card">
    <h2>Token ç”Ÿæˆå™¨ï¼ˆç®¡ç†ç•Œé¢ï¼‰</h2>
    <p class="hint">é¡µé¢æ‰˜ç®¡ï¼šGitHub Pagesã€‚æ­¤é¡µé¢ä¼šè°ƒç”¨ä½ çš„ Cloudflare Worker API æ¥åˆ›å»º Token å¹¶å†™å…¥ TOKENS KVã€‚</p>

    <label for="uid">ç›®æ ‡ UID</label>
    <input id="uid" placeholder="è¾“å…¥ç”¨æˆ· UIDï¼ˆä¾‹å¦‚ user_123ï¼‰" />

    <label for="note">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
    <input id="note" placeholder="å¯é€‰ï¼šå†™ç‚¹ç”¨é€”æˆ–æ—¶æ•ˆä¿¡æ¯ï¼Œä»…ä¾›æ˜¾ç¤º" />

    <div style="display:flex;gap:10px;margin-top:10px">
      <input id="adminKey" placeholder="ç®¡ç†å‘˜å¯†é’¥ï¼ˆä»…æœ¬åœ°ä¿å­˜ï¼‰" style="flex:1" />
      <button id="saveKey" style="width:120px">ä¿å­˜å¯†é’¥</button>
    </div>
    <div class="hint">æ³¨æ„ï¼šå‡ºäºå®‰å…¨è€ƒè™‘ï¼Œé¡µé¢åªåœ¨æµè§ˆå™¨æœ¬åœ°ä¿å­˜ Admin Keyï¼ˆlocalStorageï¼‰ï¼Œä¸ä¼šæäº¤ç»™ GitHubã€‚</div>

    <div class="row" style="margin-top:14px">
      <button id="gen" style="flex:1">ç”Ÿæˆ Token å¹¶å†™å…¥ TOKENS</button>
      <button id="genOnly" class="small">åªåœ¨å‰ç«¯ç”Ÿæˆ</button>
    </div>

    <label style="margin-top:16px">ç”Ÿæˆç»“æœ</label>
    <pre id="result">â€”</pre>

    <div class="hint">éƒ¨ç½²å®Œæˆåï¼Œè¯·æŠŠä¸‹æ–¹çš„ Worker API åœ°å€å¡«å…¥ `API_BASE`ï¼ˆé»˜è®¤ç¤ºä¾‹ï¼š<code>https://your-worker.example.workers.dev</code>ï¼‰</div>

    <label style="margin-top:10px">Worker API åœ°å€</label>
    <input id="apiBase" placeholder="https://your-worker.example.workers.dev" />

    <div class="hint">ä½¿ç”¨æ–¹æ³•ï¼šè¾“å…¥ UID â†’ å¡«å†™ç®¡ç†å‘˜å¯†é’¥ â†’ ç‚¹å‡»ã€Œç”Ÿæˆ Token å¹¶å†™å…¥ TOKENSã€ã€‚ç”Ÿæˆåä¼šè¿”å› token ä¸å†™å…¥ç»“æœã€‚</div>
  </div>

<script>
const $ = id => document.getElementById(id);
const storedKey = localStorage.getItem('admin_key_v1');
if (storedKey) $('adminKey').value = storedKey;

$('saveKey').addEventListener('click', ()=> {
  localStorage.setItem('admin_key_v1', $('adminKey').value.trim());
  alert('ç®¡ç†å‘˜å¯†é’¥å·²æœ¬åœ°ä¿å­˜ï¼ˆä»…æœ¬æœºæµè§ˆå™¨ï¼‰ã€‚');
});

$('genOnly').addEventListener('click', ()=> {
  const uid = $('uid').value.trim();
  if (!uid) { alert('è¯·è¾“å…¥ UID'); return; }
  const token = generateToken();
  $('result').textContent = `å‰ç«¯ç”Ÿæˆï¼ˆæœªå†™å…¥ KVï¼‰\nUID: ${uid}\nToken: ${token}`;
});

$('gen').addEventListener('click', async ()=> {
  const uid = $('uid').value.trim();
  const api = $('apiBase').value.trim();
  const adminKey = $('adminKey').value.trim() || localStorage.getItem('admin_key_v1');

  if (!uid) { alert('è¯·è¾“å…¥ UID'); return; }
  if (!api) { alert('è¯·è¾“å…¥ Worker API åœ°å€'); return; }
  if (!adminKey) { alert('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥ï¼ˆAdmin Keyï¼‰'); return; }

  $('result').textContent = 'æ­£åœ¨ç”Ÿæˆå¹¶å†™å…¥...';

  const token = generateToken();
  try {
    const res = await fetch(api.replace(/\/$/,'') + '/api/create-token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Admin-Key': adminKey
      },
      body: JSON.stringify({ token, uid, note: $('note').value || '' })
    });
    const json = await res.json().catch(()=>null);
    if (!res.ok) {
      $('result').textContent = `å†™å…¥å¤±è´¥ï¼š${res.status} ${res.statusText}\n${json ? JSON.stringify(json):''}`;
      return;
    }
    $('result').textContent = `å†™å…¥æˆåŠŸ âœ…\nUID: ${uid}\nToken: ${token}\nResponse: ${JSON.stringify(json)}`;
  } catch (err) {
    $('result').textContent = 'ç½‘ç»œé”™è¯¯ï¼š' + err;
  }
});

function generateToken() {
  // 32 å­—èŠ‚ hexï¼ˆå¯æ”¹ä¸ºä½ è‡ªå·±çš„ç”Ÿæˆè§„åˆ™ï¼‰
  const arr = new Uint8Array(16);
  crypto.getRandomValues(arr);
  return Array.from(arr).map(b => b.toString(16).padStart(2,'0')).join('');
}
</script>
</body>
</html>
